{"version":3,"file":"content.js","mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://safesignal-extension/./src/content/content.js"],"sourcesContent":["class SafeSignalBadge {\r\n    constructor() {\r\n        this.shadowRoot = null;\r\n        this.badgeContainer = null;\r\n        this.currentState = 'checking';\r\n        this.isVisible = true;\r\n        \r\n        // Enhanced positioning system\r\n        this.positioning = {\r\n            anchor: 'bottom-right',\r\n            offsetX: 0,\r\n            offsetY: 0\r\n        };\r\n        \r\n        // SPA Detection properties\r\n        this.currentUrl = window.location.href;\r\n        this.currentSignature = null;\r\n        this.mutationObserver = null;\r\n        this.pageDebounceTimer = null;\r\n        this.contentDebounceTimer = null;\r\n        this.lastCheck = 0;\r\n        this.checkCooldown = 30 * 60 * 1000; // 30 minutes\r\n        this.sessionUpdateCounts = new Map();\r\n        this.cleanupHandlers = [];\r\n        \r\n        // UI state\r\n        this.isMenuOpen = false;\r\n        this.isDragging = false;\r\n        this.isCompact = false;\r\n        this.dragStartPos = null;\r\n        this.longPressTimer = null;\r\n        this.scrollTimer = null;\r\n        this.suppressNextClickUntil = 0;\r\n        this._dragArmedUntil = 0;\r\n        this._onDocPointerMove = null;\r\n        this._onDocPointerUp = null;\r\n        this._onDocPointerCancel = null;\r\n        this.userPreferences = {\r\n            positioning: { anchor: 'bottom-right', offsetX: 0, offsetY: 0 },\r\n            hiddenSites: new Set()\r\n        };\r\n        \r\n        this.init();\r\n    }\r\n\r\n    async init() {\r\n        if (this.shouldSkipInjection()) {\r\n            return;\r\n        }\r\n\r\n        await this.loadUserPreferences();\r\n        \r\n        if (this.isSiteHidden()) {\r\n            console.log('SafeSignal: Badge hidden on this site per user preference');\r\n            return;\r\n        }\r\n\r\n        this.createShadowDOMBadge();\r\n        this.attachEventListeners();\r\n        this.setupSPADetection();\r\n        this.setupScrollDetection();\r\n        \r\n        // Apply saved positioning\r\n        this.applyPositioning(this.userPreferences.positioning);\r\n        \r\n        this.checkIfPageChanged('initial_load');\r\n        \r\n        console.log('SafeSignal: Phase 1.4+ Enhanced positioning & controls active');\r\n    }\r\n\r\n    shouldSkipInjection() {\r\n        const protocol = window.location.protocol;\r\n        \r\n        if (protocol === 'chrome:' || \r\n            protocol === 'chrome-extension:' ||\r\n            protocol === 'moz-extension:' ||\r\n            protocol === 'about:') {\r\n            return true;\r\n        }\r\n        \r\n        if (window.top !== window) {\r\n            console.log('SafeSignal: Skipping injection in embedded frame');\r\n            return true;\r\n        }\r\n        \r\n        return false;\r\n    }\r\n\r\n    // === UTILITY METHODS ===\r\n    \r\n    getOriginKey() {\r\n        return `${window.location.protocol}//${window.location.host}`;\r\n    }\r\n\r\n    // === ENHANCED POSITIONING SYSTEM ===\r\n    \r\n    getBadgeRect() {\r\n        const el = this.shadowRoot?.querySelector('.badge');\r\n        return el ? el.getBoundingClientRect() : { width: 48, height: 48, left: 0, top: 0 };\r\n    }\r\n    \r\n    getAnchorPositions() {\r\n        const padding = 16; // Safe edge padding\r\n        const systemBarHeight = 80; // Bottom system bar clearance\r\n        const viewportWidth = window.innerWidth;\r\n        const viewportHeight = window.innerHeight;\r\n        \r\n        return {\r\n            'top-left': { x: padding, y: padding },\r\n            'top-right': { x: viewportWidth - padding, y: padding },\r\n            'mid-left': { x: padding, y: viewportHeight / 2 },\r\n            'mid-right': { x: viewportWidth - padding, y: viewportHeight / 2 },\r\n            'bottom-left': { x: padding, y: viewportHeight - systemBarHeight },\r\n            'bottom-right': { x: viewportWidth - padding, y: viewportHeight - systemBarHeight }\r\n        };\r\n    }\r\n\r\n    applyPositioning(positioning) {\r\n        if (!this.shadowRoot) return;\r\n        \r\n        const { anchor, offsetX = 0, offsetY = 0 } = positioning;\r\n        const anchorPositions = this.getAnchorPositions();\r\n        const anchorPos = anchorPositions[anchor] || anchorPositions['bottom-right'];\r\n        \r\n        const badge = this.shadowRoot.querySelector('.badge');\r\n        if (!badge) return;\r\n        \r\n        const { width: badgeW, height: badgeH } = this.getBadgeRect();\r\n        \r\n        // Calculate final position\r\n        let finalX = anchorPos.x + offsetX;\r\n        let finalY = anchorPos.y + offsetY;\r\n        \r\n        // Adjust for badge size based on anchor\r\n        if (anchor.includes('right')) finalX -= badgeW;\r\n        if (anchor.includes('bottom')) finalY -= badgeH;\r\n        if (anchor.includes('mid')) {\r\n            if (anchor.includes('left') || anchor.includes('right')) {\r\n                finalY -= badgeH / 2;\r\n            }\r\n        }\r\n        \r\n        // Apply safe bounds\r\n        finalX = Math.max(12, Math.min(finalX, window.innerWidth - badgeW - 12));\r\n        finalY = Math.max(12, Math.min(finalY, window.innerHeight - badgeH - 12));\r\n        \r\n        // Check for collision avoidance\r\n        const collisionResult = this.applyCollisionAvoidance(finalX, finalY, badgeW, badgeH);\r\n        finalX = collisionResult.x;\r\n        finalY = collisionResult.y;\r\n        \r\n        // Apply position\r\n        badge.style.position = 'fixed';\r\n        badge.style.left = `${finalX}px`;\r\n        badge.style.top = `${finalY}px`;\r\n        badge.style.right = 'auto';\r\n        badge.style.bottom = 'auto';\r\n        \r\n        // Update internal state\r\n        this.positioning = { anchor, offsetX, offsetY };\r\n        \r\n        // Update active state in UI\r\n        this.updatePositionGridUI(anchor);\r\n        \r\n        // Apply size adjustment for mid positions\r\n        if (anchor.includes('mid')) {\r\n            badge.classList.add('mid-position');\r\n        } else {\r\n            badge.classList.remove('mid-position');\r\n        }\r\n        \r\n        console.log('SafeSignal: Applied positioning:', { anchor, offsetX, offsetY, finalX, finalY });\r\n    }\r\n\r\n    applyCollisionAvoidance(x, y, badgeW, badgeH) {\r\n        // Check for overlapping high-z fixed elements\r\n        const elementsAtPosition = document.elementsFromPoint(\r\n            x + badgeW / 2, \r\n            y + badgeH / 2\r\n        ).filter(el => el !== this.badgeContainer);\r\n        \r\n        const hasCollision = elementsAtPosition.some(el => {\r\n            const style = window.getComputedStyle(el);\r\n            return style.position === 'fixed' && \r\n                   style.zIndex !== 'auto' && \r\n                   parseInt(style.zIndex) > 1000;\r\n        });\r\n        \r\n        if (hasCollision) {\r\n            // Apply small nudge without overwriting saved offsets\r\n            const nudgeX = x + 12 > window.innerWidth / 2 ? -12 : 12;\r\n            const nudgeY = y + 12 > window.innerHeight / 2 ? -12 : 12;\r\n            \r\n            return {\r\n                x: Math.max(12, Math.min(x + nudgeX, window.innerWidth - badgeW - 12)),\r\n                y: Math.max(12, Math.min(y + nudgeY, window.innerHeight - badgeH - 12))\r\n            };\r\n        }\r\n        \r\n        return { x, y };\r\n    }\r\n\r\n    updatePositionGridUI(activeAnchor) {\r\n        if (!this.shadowRoot) return;\r\n        \r\n        const positionOptions = this.shadowRoot.querySelectorAll('.position-option');\r\n        positionOptions.forEach(option => {\r\n            option.classList.remove('active');\r\n            if (option.dataset.position === activeAnchor) {\r\n                option.classList.add('active');\r\n            }\r\n        });\r\n    }\r\n\r\n    findNearestAnchor(x, y) {\r\n        const anchorPositions = this.getAnchorPositions();\r\n        let nearestAnchor = 'bottom-right';\r\n        let minDistance = Infinity;\r\n        \r\n        Object.entries(anchorPositions).forEach(([anchor, pos]) => {\r\n            const distance = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));\r\n            if (distance < minDistance) {\r\n                minDistance = distance;\r\n                nearestAnchor = anchor;\r\n            }\r\n        });\r\n        \r\n        return nearestAnchor;\r\n    }\r\n\r\n    calculateOffsetFromAnchor(centerX, centerY, anchor) {\r\n        const anchorPositions = this.getAnchorPositions();\r\n        const anchorPos = anchorPositions[anchor];\r\n        const { width: badgeW, height: badgeH } = this.getBadgeRect();\r\n        \r\n        // Convert the badge center position into the same \"top/left\" placement frame used by applyPositioning\r\n        let targetX = centerX, targetY = centerY;\r\n        if (anchor.includes('right')) targetX -= badgeW;\r\n        if (anchor.includes('bottom')) targetY -= badgeH;\r\n        if (anchor.includes('mid')) targetY -= badgeH / 2;\r\n        \r\n        return { \r\n            offsetX: Math.round(targetX - anchorPos.x), \r\n            offsetY: Math.round(targetY - anchorPos.y) \r\n        };\r\n    }\r\n\r\n    // === STORAGE & PREFERENCES ===\r\n\r\n    async loadUserPreferences() {\r\n        try {\r\n            if (!chrome?.storage?.sync) {\r\n                console.warn('SafeSignal: Chrome storage not available, using defaults');\r\n                return;\r\n            }\r\n            \r\n            const result = await chrome.storage.sync.get([\r\n                'safesignal_positioning',\r\n                'safesignal_hidden_sites',\r\n                'safesignal_positions' // Legacy key for migration\r\n            ]);\r\n            \r\n            const origin = this.getOriginKey();\r\n            \r\n            // Migrate old key if present\r\n            if (!result.safesignal_positioning?.[origin] && result.safesignal_positions?.[origin]) {\r\n                const anchor = result.safesignal_positions[origin];\r\n                const newPositioning = { \r\n                    ...(result.safesignal_positioning || {}), \r\n                    [origin]: { anchor, offsetX: 0, offsetY: 0 } \r\n                };\r\n                await chrome.storage.sync.set({ \r\n                    safesignal_positioning: newPositioning\r\n                });\r\n                console.log('SafeSignal: Migrated legacy position data for', origin);\r\n            }\r\n            \r\n            const positioningData = result.safesignal_positioning || {};\r\n            const hiddenSites = result.safesignal_hidden_sites || [];\r\n            \r\n            this.userPreferences.positioning = positioningData[origin] || \r\n                { anchor: 'bottom-right', offsetX: 0, offsetY: 0 };\r\n            this.userPreferences.hiddenSites = new Set(hiddenSites);\r\n            \r\n            console.log('SafeSignal: Loaded preferences:', this.userPreferences);\r\n        } catch (e) {\r\n            console.warn('SafeSignal: Could not load preferences:', e);\r\n        }\r\n    }\r\n\r\n    async savePositioningPreference(positioning) {\r\n        try {\r\n            if (!chrome?.storage?.sync) {\r\n                console.warn('SafeSignal: Chrome storage not available');\r\n                return;\r\n            }\r\n            \r\n            const result = await chrome.storage.sync.get(['safesignal_positioning']);\r\n            const positioningData = result.safesignal_positioning || {};\r\n            \r\n            const origin = this.getOriginKey();\r\n            positioningData[origin] = positioning;\r\n            \r\n            await chrome.storage.sync.set({\r\n                safesignal_positioning: positioningData\r\n            });\r\n            \r\n            this.userPreferences.positioning = positioning;\r\n            console.log('SafeSignal: Saved positioning preference:', positioning, 'for', origin);\r\n        } catch (e) {\r\n            console.warn('SafeSignal: Could not save positioning preference:', e);\r\n        }\r\n    }\r\n\r\n    async toggleSiteVisibility() {\r\n        try {\r\n            if (!chrome?.storage?.sync) {\r\n                console.warn('SafeSignal: Chrome storage not available');\r\n                return;\r\n            }\r\n            \r\n            const origin = this.getOriginKey();\r\n            const result = await chrome.storage.sync.get(['safesignal_hidden_sites']);\r\n            const hiddenSites = new Set(result.safesignal_hidden_sites || []);\r\n            \r\n            if (hiddenSites.has(origin)) {\r\n                hiddenSites.delete(origin);\r\n                await chrome.storage.sync.set({\r\n                    safesignal_hidden_sites: Array.from(hiddenSites)\r\n                });\r\n                \r\n                console.log('SafeSignal: Unhidden site:', origin);\r\n                this.show();\r\n            } else {\r\n                hiddenSites.add(origin);\r\n                await chrome.storage.sync.set({\r\n                    safesignal_hidden_sites: Array.from(hiddenSites)\r\n                });\r\n                \r\n                console.log('SafeSignal: Hidden site:', origin);\r\n                this.hide();\r\n                setTimeout(() => this.destroy(), 100);\r\n            }\r\n            \r\n            this.userPreferences.hiddenSites = hiddenSites;\r\n        } catch (e) {\r\n            console.warn('SafeSignal: Could not toggle site visibility:', e);\r\n        }\r\n    }\r\n\r\n    isSiteHidden() {\r\n        const origin = this.getOriginKey();\r\n        return this.userPreferences.hiddenSites.has(origin);\r\n    }\r\n\r\n    // === BADGE CREATION ===\r\n\r\n    createShadowDOMBadge() {\r\n        this.badgeContainer = document.createElement('div');\r\n        this.badgeContainer.id = 'safesignal-badge-container';\r\n        this.shadowRoot = this.badgeContainer.attachShadow({ mode: 'closed' });\r\n        \r\n        this.shadowRoot.innerHTML = `\r\n            <style>\r\n                :host {\r\n                    all: initial;\r\n                }\r\n                \r\n                .badge {\r\n                    position: fixed;\r\n                    width: 3rem;\r\n                    height: 3rem;\r\n                    border-radius: 50%;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\r\n                    font-size: 1.25rem;\r\n                    font-weight: 600;\r\n                    cursor: pointer;\r\n                    user-select: none;\r\n                    z-index: 2147483647;\r\n                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);\r\n                    transition: all 0.2s ease;\r\n                    transform: scale(1);\r\n                    backdrop-filter: blur(8px);\r\n                    touch-action: none;\r\n                }\r\n                \r\n                @media (prefers-reduced-motion: reduce) {\r\n                    .badge {\r\n                        transition: none;\r\n                        animation: none !important;\r\n                    }\r\n                }\r\n                \r\n                .badge.mid-position {\r\n                    transform: scale(0.85);\r\n                }\r\n                \r\n                .badge.mid-position:hover {\r\n                    transform: scale(0.9);\r\n                }\r\n                \r\n                .badge.compact {\r\n                    width: 2rem;\r\n                    height: 2rem;\r\n                    font-size: 1rem;\r\n                    opacity: 0.8;\r\n                }\r\n                \r\n                .badge.compact:hover {\r\n                    width: 3rem;\r\n                    height: 3rem;\r\n                    font-size: 1.25rem;\r\n                    opacity: 1;\r\n                }\r\n                \r\n                .badge-status {\r\n                    position: absolute;\r\n                    bottom: -45px;\r\n                    left: 50%;\r\n                    transform: translateX(-50%);\r\n                    background: rgba(0, 0, 0, 0.9);\r\n                    color: white;\r\n                    padding: 8px 12px;\r\n                    border-radius: 8px;\r\n                    font-size: 0.75rem;\r\n                    white-space: nowrap;\r\n                    pointer-events: none;\r\n                    opacity: 0;\r\n                    transition: opacity 0.2s ease;\r\n                    z-index: 2147483648;\r\n                    max-width: 200px;\r\n                    word-wrap: break-word;\r\n                    white-space: normal;\r\n                    text-align: center;\r\n                    line-height: 1.2;\r\n                }\r\n                \r\n                .badge.show-status .badge-status {\r\n                    opacity: 1;\r\n                }\r\n                \r\n                .menu-button {\r\n                    position: absolute;\r\n                    top: -8px;\r\n                    right: -8px;\r\n                    width: 20px;\r\n                    height: 20px;\r\n                    border-radius: 50%;\r\n                    background: rgba(0, 0, 0, 0.7);\r\n                    color: white;\r\n                    border: none;\r\n                    font-size: 12px;\r\n                    font-weight: bold;\r\n                    cursor: pointer;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    opacity: 0;\r\n                    transition: opacity 0.2s ease;\r\n                    z-index: 2147483649;\r\n                }\r\n                \r\n                .badge:hover .menu-button,\r\n                .badge:focus .menu-button {\r\n                    opacity: 1;\r\n                }\r\n                \r\n                .menu-button:hover {\r\n                    background: rgba(0, 0, 0, 0.9);\r\n                    transform: scale(1.1);\r\n                }\r\n                \r\n                .badge-menu {\r\n                    position: absolute;\r\n                    top: 100%;\r\n                    right: 0;\r\n                    background: white;\r\n                    border-radius: 12px;\r\n                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), 0 4px 16px rgba(0, 0, 0, 0.1);\r\n                    padding: 12px;\r\n                    min-width: 220px;\r\n                    opacity: 0;\r\n                    transform: translateY(-10px) scale(0.95);\r\n                    pointer-events: none;\r\n                    transition: all 0.2s ease;\r\n                    z-index: 2147483650;\r\n                    border: 1px solid rgba(0, 0, 0, 0.08);\r\n                }\r\n                \r\n                .badge-menu.open {\r\n                    opacity: 1;\r\n                    transform: translateY(0) scale(1);\r\n                    pointer-events: auto;\r\n                }\r\n                \r\n                .menu-section {\r\n                    margin-bottom: 12px;\r\n                }\r\n                \r\n                .menu-section:last-child {\r\n                    margin-bottom: 0;\r\n                }\r\n                \r\n                .menu-label {\r\n                    font-size: 0.75rem;\r\n                    font-weight: 600;\r\n                    color: #6b7280;\r\n                    margin-bottom: 8px;\r\n                    text-transform: uppercase;\r\n                    letter-spacing: 0.05em;\r\n                }\r\n                \r\n                .position-grid {\r\n                    display: grid;\r\n                    grid-template-columns: repeat(3, 1fr);\r\n                    gap: 6px;\r\n                    margin-bottom: 12px;\r\n                }\r\n                \r\n                .position-option {\r\n                    width: 36px;\r\n                    height: 36px;\r\n                    border: 2px solid #e5e7eb;\r\n                    border-radius: 8px;\r\n                    background: #f9fafb;\r\n                    cursor: pointer;\r\n                    position: relative;\r\n                    transition: all 0.15s ease;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                }\r\n                \r\n                .position-option:hover {\r\n                    border-color: #3b82f6;\r\n                    background: #eff6ff;\r\n                    transform: scale(1.05);\r\n                }\r\n                \r\n                .position-option.active {\r\n                    border-color: #3b82f6;\r\n                    background: #3b82f6;\r\n                }\r\n                \r\n                .position-option::after {\r\n                    content: '';\r\n                    position: absolute;\r\n                    width: 8px;\r\n                    height: 8px;\r\n                    background: #6b7280;\r\n                    border-radius: 50%;\r\n                    transition: background 0.15s ease;\r\n                }\r\n                \r\n                .position-option.active::after {\r\n                    background: white;\r\n                }\r\n                \r\n                .position-option[data-position=\"top-left\"]::after {\r\n                    top: 6px;\r\n                    left: 6px;\r\n                }\r\n                \r\n                .position-option[data-position=\"top-right\"]::after {\r\n                    top: 6px;\r\n                    right: 6px;\r\n                }\r\n                \r\n                .position-option[data-position=\"mid-left\"]::after {\r\n                    top: 50%;\r\n                    left: 6px;\r\n                    transform: translateY(-50%);\r\n                }\r\n                \r\n                .position-option[data-position=\"mid-right\"]::after {\r\n                    top: 50%;\r\n                    right: 6px;\r\n                    transform: translateY(-50%);\r\n                }\r\n                \r\n                .position-option[data-position=\"bottom-left\"]::after {\r\n                    bottom: 6px;\r\n                    left: 6px;\r\n                }\r\n                \r\n                .position-option[data-position=\"bottom-right\"]::after {\r\n                    bottom: 6px;\r\n                    right: 6px;\r\n                }\r\n                \r\n                .menu-item {\r\n                    width: 100%;\r\n                    padding: 10px 14px;\r\n                    border: none;\r\n                    background: #f9fafb;\r\n                    color: #374151;\r\n                    font-size: 0.875rem;\r\n                    border-radius: 8px;\r\n                    cursor: pointer;\r\n                    transition: all 0.15s ease;\r\n                    text-align: left;\r\n                    font-family: inherit;\r\n                }\r\n                \r\n                .menu-item:hover {\r\n                    background: #f3f4f6;\r\n                    color: #111827;\r\n                    transform: translateY(-1px);\r\n                }\r\n                \r\n                .menu-item.danger {\r\n                    color: #dc2626;\r\n                }\r\n                \r\n                .menu-item.danger:hover {\r\n                    background: #fef2f2;\r\n                    color: #991b1b;\r\n                }\r\n                \r\n                .badge:hover {\r\n                    transform: scale(1.05);\r\n                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2), 0 2px 8px rgba(0, 0, 0, 0.15);\r\n                }\r\n                \r\n                .badge:active {\r\n                    transform: scale(0.95);\r\n                }\r\n                \r\n                .badge.checking {\r\n                    background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);\r\n                    color: white;\r\n                    animation: pulse 2s infinite;\r\n                }\r\n                \r\n                .badge.ok {\r\n                    background: linear-gradient(135deg, #10b981 0%, #34d399 100%);\r\n                    color: white;\r\n                }\r\n                \r\n                .badge.warning {\r\n                    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);\r\n                    color: white;\r\n                }\r\n                \r\n                .badge.danger {\r\n                    background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);\r\n                    color: white;\r\n                }\r\n                \r\n                @keyframes pulse {\r\n                    0%, 100% { opacity: 1; }\r\n                    50% { opacity: 0.7; }\r\n                }\r\n                \r\n                .badge:focus {\r\n                    outline: 3px solid #3b82f6;\r\n                    outline-offset: 2px;\r\n                }\r\n                \r\n                .badge.hidden {\r\n                    display: none;\r\n                }\r\n                \r\n                .badge.near-input {\r\n                    opacity: 0.6;\r\n                }\r\n            </style>\r\n            \r\n            <div class=\"badge checking\" \r\n                 role=\"button\" \r\n                 tabindex=\"0\"\r\n                 aria-label=\"SafeSignal security indicator\"\r\n                 aria-live=\"polite\"\r\n                 title=\"SafeSignal - Checking page safety\">\r\n                <span class=\"badge-icon\">S</span>\r\n                <div class=\"badge-status\" role=\"status\" aria-live=\"polite\">Checking...</div>\r\n                \r\n                <button class=\"menu-button\" \r\n                        type=\"button\"\r\n                        title=\"Badge options\"\r\n                        aria-label=\"Open badge options menu\">⋯</button>\r\n                \r\n                <div class=\"badge-menu\" role=\"menu\" aria-label=\"Badge options\">\r\n                    <div class=\"menu-section\">\r\n                        <div class=\"menu-label\">Position</div>\r\n                        <div class=\"position-grid\" role=\"group\" aria-label=\"Badge position options\">\r\n                            <button class=\"position-option\" \r\n                                    data-position=\"top-left\" \r\n                                    type=\"button\"\r\n                                    title=\"Top Left\"\r\n                                    aria-label=\"Move badge to top left\"></button>\r\n                            <div></div>\r\n                            <button class=\"position-option\" \r\n                                    data-position=\"top-right\" \r\n                                    type=\"button\"\r\n                                    title=\"Top Right\"\r\n                                    aria-label=\"Move badge to top right\"></button>\r\n                            <button class=\"position-option\" \r\n                                    data-position=\"mid-left\" \r\n                                    type=\"button\"\r\n                                    title=\"Middle Left\"\r\n                                    aria-label=\"Move badge to middle left\"></button>\r\n                            <div></div>\r\n                            <button class=\"position-option\" \r\n                                    data-position=\"mid-right\" \r\n                                    type=\"button\"\r\n                                    title=\"Middle Right\"\r\n                                    aria-label=\"Move badge to middle right\"></button>\r\n                            <button class=\"position-option\" \r\n                                    data-position=\"bottom-left\" \r\n                                    type=\"button\"\r\n                                    title=\"Bottom Left\"\r\n                                    aria-label=\"Move badge to bottom left\"></button>\r\n                            <div></div>\r\n                            <button class=\"position-option active\" \r\n                                    data-position=\"bottom-right\" \r\n                                    type=\"button\"\r\n                                    title=\"Bottom Right\"\r\n                                    aria-label=\"Move badge to bottom right\"></button>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"menu-section\">\r\n                        <button class=\"menu-item danger\" \r\n                                type=\"button\"\r\n                                role=\"menuitem\"\r\n                                data-action=\"hide-site\">Hide on this site</button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n        \r\n        document.body.appendChild(this.badgeContainer);\r\n    }\r\n\r\n    attachEventListeners() {\r\n        const badge = this.shadowRoot.querySelector('.badge');\r\n        const menuButton = this.shadowRoot.querySelector('.menu-button');\r\n        const menu = this.shadowRoot.querySelector('.badge-menu');\r\n        \r\n        // Badge interactions\r\n        badge.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            if (performance.now() < this.suppressNextClickUntil) return;\r\n            if (!this.isMenuOpen && !this.isDragging) {\r\n                this.handleBadgeClick();\r\n            }\r\n        });\r\n        \r\n        // Keyboard navigation\r\n        badge.addEventListener('keydown', (e) => {\r\n            this.handleKeyboardNavigation(e);\r\n        });\r\n        \r\n        // Menu button\r\n        menuButton.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            e.preventDefault();\r\n            this.toggleMenu();\r\n        });\r\n        \r\n        // Position options\r\n        const positionOptions = this.shadowRoot.querySelectorAll('.position-option');\r\n        positionOptions.forEach(option => {\r\n            option.addEventListener('click', (e) => {\r\n                e.stopPropagation();\r\n                const anchor = option.dataset.position;\r\n                this.handlePositionSelect(anchor);\r\n            });\r\n        });\r\n        \r\n        // Menu actions\r\n        const hideSiteButton = this.shadowRoot.querySelector('[data-action=\"hide-site\"]');\r\n        hideSiteButton.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            this.toggleSiteVisibility();\r\n        });\r\n        \r\n        // Close menu when clicking outside\r\n        document.addEventListener('click', () => {\r\n            this.closeMenu();\r\n        });\r\n        \r\n        // Prevent menu clicks from closing menu\r\n        menu.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n        });\r\n        \r\n        // Window resize handler with throttling\r\n        let resizeRaf = null;\r\n        const onResize = () => {\r\n            if (resizeRaf) return;\r\n            resizeRaf = requestAnimationFrame(() => {\r\n                resizeRaf = null;\r\n                this.applyPositioning(this.positioning);\r\n            });\r\n        };\r\n        window.addEventListener('resize', onResize);\r\n        this.cleanupHandlers.push(() => window.removeEventListener('resize', onResize));\r\n        \r\n        // Input proximity detection\r\n        setInterval(() => {\r\n            this.checkInputProximity();\r\n        }, 1000);\r\n    }\r\n\r\n    checkInputProximity() {\r\n        if (this.isDragging || this.isMenuOpen) return;\r\n        \r\n        const badge = this.shadowRoot.querySelector('.badge');\r\n        const rect = badge.getBoundingClientRect();\r\n        \r\n        const elementsNearby = document.elementsFromPoint(\r\n            rect.left + rect.width / 2,\r\n            rect.top + rect.height / 2\r\n        );\r\n        \r\n        const nearInput = elementsNearby.some(el => {\r\n            return el.tagName === 'INPUT' || \r\n                   el.tagName === 'TEXTAREA' || \r\n                   el.isContentEditable;\r\n        });\r\n        \r\n        if (nearInput) {\r\n            badge.classList.add('near-input');\r\n        } else {\r\n            badge.classList.remove('near-input');\r\n        }\r\n    }\r\n\r\n    handleBadgeClick() {\r\n        const badge = this.shadowRoot.querySelector('.badge');\r\n        const statusEl = this.shadowRoot.querySelector('.badge-status');\r\n        \r\n        const stateMessages = {\r\n            checking: 'Analyzing page...',\r\n            ok: 'Page appears safe ✅',\r\n            warning: 'Exercise caution ⚠️',\r\n            danger: 'Risk signals detected ❌'\r\n        };\r\n        \r\n        const message = stateMessages[this.currentState] || 'SafeSignal active';\r\n        statusEl.textContent = message;\r\n        badge.classList.add('show-status');\r\n        \r\n        setTimeout(() => {\r\n            badge.classList.remove('show-status');\r\n        }, 3000);\r\n        \r\n        console.log('SafeSignal: Badge clicked, current state:', this.currentState);\r\n    }\r\n\r\n    setState(newState, options = {}) {\r\n        if (!['checking', 'ok', 'warning', 'danger'].includes(newState)) {\r\n            console.warn('SafeSignal: Invalid state:', newState);\r\n            return;\r\n        }\r\n\r\n        this.currentState = newState;\r\n        const badge = this.shadowRoot.querySelector('.badge');\r\n        const icon = this.shadowRoot.querySelector('.badge-icon');\r\n        const statusEl = this.shadowRoot.querySelector('.badge-status');\r\n        \r\n        badge.classList.remove('checking', 'ok', 'warning', 'danger');\r\n        badge.classList.add(newState);\r\n        \r\n        const stateConfig = {\r\n            checking: { \r\n                icon: 'S', \r\n                label: 'SafeSignal - Checking page safety', \r\n                title: 'SafeSignal - Checking page safety',\r\n                status: 'Checking...'\r\n            },\r\n            ok: { \r\n                icon: '✓', \r\n                label: 'SafeSignal - Page appears safe', \r\n                title: 'SafeSignal - Page appears safe',\r\n                status: 'Safe'\r\n            },\r\n            warning: { \r\n                icon: '⚠', \r\n                label: 'SafeSignal - Exercise caution', \r\n                title: 'SafeSignal - Exercise caution',\r\n                status: 'Caution'\r\n            },\r\n            danger: { \r\n                icon: '⚠', \r\n                label: 'SafeSignal - Risk signals detected', \r\n                title: 'SafeSignal - Risk signals detected',\r\n                status: 'Risk detected'\r\n            }\r\n        };\r\n        \r\n        const config = stateConfig[newState];\r\n        icon.textContent = config.icon;\r\n        badge.setAttribute('aria-label', config.label);\r\n        badge.setAttribute('title', config.title);\r\n        statusEl.textContent = config.status;\r\n        \r\n        console.log('SafeSignal: State changed to:', newState);\r\n    }\r\n\r\n    // === SCROLL DETECTION & AUTO-MINIMIZE ===\r\n\r\n    setupScrollDetection() {\r\n        let scrollTimeout;\r\n        let isScrolling = false;\r\n        \r\n        const handleScroll = () => {\r\n            if (!isScrolling) {\r\n                isScrolling = true;\r\n                // Start compact mode after 1 second of scrolling\r\n                this.scrollTimer = setTimeout(() => {\r\n                    this.setCompactMode(true);\r\n                }, 1000);\r\n            }\r\n            \r\n            // Reset the timer\r\n            clearTimeout(scrollTimeout);\r\n            scrollTimeout = setTimeout(() => {\r\n                isScrolling = false;\r\n                clearTimeout(this.scrollTimer);\r\n                // Exit compact mode after 2 seconds of no scrolling\r\n                setTimeout(() => {\r\n                    this.setCompactMode(false);\r\n                }, 2000);\r\n            }, 150);\r\n        };\r\n        \r\n        window.addEventListener('scroll', handleScroll, { passive: true });\r\n        this.cleanupHandlers.push(() => {\r\n            window.removeEventListener('scroll', handleScroll);\r\n            clearTimeout(this.scrollTimer);\r\n        });\r\n    }\r\n\r\n    setCompactMode(compact) {\r\n        if (this.isCompact === compact) return;\r\n        \r\n        this.isCompact = compact;\r\n        const badge = this.shadowRoot.querySelector('.badge');\r\n        \r\n        if (compact) {\r\n            badge.classList.add('compact');\r\n        } else {\r\n            badge.classList.remove('compact');\r\n        }\r\n        \r\n        console.log('SafeSignal: Compact mode:', compact);\r\n    }\r\n\r\n    // === KEYBOARD NAVIGATION ===\r\n\r\n    handleKeyboardNavigation(e) {\r\n        if (!this.isVisible) return;\r\n        \r\n        const step = e.shiftKey ? 24 : 8;\r\n        let deltaX = 0;\r\n        let deltaY = 0;\r\n        \r\n        switch (e.key) {\r\n            case 'ArrowLeft':\r\n                deltaX = -step;\r\n                break;\r\n            case 'ArrowRight':\r\n                deltaX = step;\r\n                break;\r\n            case 'ArrowUp':\r\n                deltaY = -step;\r\n                break;\r\n            case 'ArrowDown':\r\n                deltaY = step;\r\n                break;\r\n            case 'Enter':\r\n            case ' ':\r\n                if (!this.isMenuOpen) {\r\n                    this.toggleMenu();\r\n                }\r\n                e.preventDefault();\r\n                return;\r\n            case 'Escape':\r\n                this.closeMenu();\r\n                e.preventDefault();\r\n                return;\r\n            default:\r\n                return;\r\n        }\r\n        \r\n        if (deltaX !== 0 || deltaY !== 0) {\r\n            e.preventDefault();\r\n            \r\n            const newPositioning = {\r\n                ...this.positioning,\r\n                offsetX: this.positioning.offsetX + deltaX,\r\n                offsetY: this.positioning.offsetY + deltaY\r\n            };\r\n            \r\n            this.applyPositioning(newPositioning);\r\n            this.savePositioningPreference(newPositioning);\r\n        }\r\n    }\r\n\r\n    // === MENU SYSTEM ===\r\n\r\n    toggleMenu() {\r\n        this.isMenuOpen = !this.isMenuOpen;\r\n        const menu = this.shadowRoot.querySelector('.badge-menu');\r\n        const badge = this.shadowRoot.querySelector('.badge');\r\n        \r\n        if (this.isMenuOpen) {\r\n            menu.classList.add('open');\r\n            badge.classList.add('menu-open');\r\n            const firstButton = menu.querySelector('.menu-item, .position-option');\r\n            if (firstButton) firstButton.focus();\r\n        } else {\r\n            menu.classList.remove('open');\r\n            badge.classList.remove('menu-open');\r\n        }\r\n    }\r\n\r\n    closeMenu() {\r\n        if (this.isMenuOpen) {\r\n            this.isMenuOpen = false;\r\n            const menu = this.shadowRoot.querySelector('.badge-menu');\r\n            const badge = this.shadowRoot.querySelector('.badge');\r\n            menu.classList.remove('open');\r\n            badge.classList.remove('menu-open');\r\n        }\r\n    }\r\n\r\n    handlePositionSelect(anchor) {\r\n        const newPositioning = { anchor, offsetX: 0, offsetY: 0 };\r\n        this.applyPositioning(newPositioning);\r\n        this.savePositioningPreference(newPositioning);\r\n        this.closeMenu();\r\n        this.showPositionConfirmation(anchor);\r\n    }\r\n\r\n    showPositionConfirmation(message) {\r\n        const statusEl = this.shadowRoot.querySelector('.badge-status');\r\n        const badge = this.shadowRoot.querySelector('.badge');\r\n        \r\n        if (typeof message === 'string') {\r\n            statusEl.textContent = message;\r\n        } else {\r\n            const friendlyNames = {\r\n                'bottom-right': 'Bottom Right',\r\n                'bottom-left': 'Bottom Left', \r\n                'top-right': 'Top Right',\r\n                'top-left': 'Top Left',\r\n                'mid-right': 'Middle Right',\r\n                'mid-left': 'Middle Left'\r\n            };\r\n            statusEl.textContent = `Moved to ${friendlyNames[message]}`;\r\n        }\r\n        \r\n        badge.classList.add('show-status');\r\n        \r\n        setTimeout(() => {\r\n            badge.classList.remove('show-status');\r\n        }, 2000);\r\n    }\r\n\r\n    hide() {\r\n        const badge = this.shadowRoot.querySelector('.badge');\r\n        badge.classList.add('hidden');\r\n        this.isVisible = false;\r\n    }\r\n\r\n    show() {\r\n        const badge = this.shadowRoot.querySelector('.badge');\r\n        badge.classList.remove('hidden');\r\n        this.isVisible = true;\r\n    }\r\n\r\n    // === SPA DETECTION SYSTEM ===\r\n\r\n    setupSPADetection() {\r\n        this.patchHistoryAPI();\r\n        \r\n        const popstateHandler = () => this.handleURLChange('popstate');\r\n        window.addEventListener('popstate', popstateHandler);\r\n        this.cleanupHandlers.push(() => window.removeEventListener('popstate', popstateHandler));\r\n        \r\n        const hashchangeHandler = () => this.handleURLChange('hashchange');\r\n        window.addEventListener('hashchange', hashchangeHandler);\r\n        this.cleanupHandlers.push(() => window.removeEventListener('hashchange', hashchangeHandler));\r\n        \r\n        const pageshowHandler = (e) => {\r\n            if (e.persisted) {\r\n                console.log('SafeSignal: Page restored from BFCache, re-initializing');\r\n                this.checkIfPageChanged('bfcache_restore');\r\n            }\r\n        };\r\n        const pagehideHandler = () => this.destroy();\r\n        \r\n        window.addEventListener('pageshow', pageshowHandler);\r\n        window.addEventListener('pagehide', pagehideHandler);\r\n        this.cleanupHandlers.push(() => {\r\n            window.removeEventListener('pageshow', pageshowHandler);\r\n            window.removeEventListener('pagehide', pagehideHandler);\r\n        });\r\n        \r\n        this.setupMutationObserver();\r\n        this.updateContentSignature();\r\n    }\r\n\r\n    patchHistoryAPI() {\r\n        const originalPushState = history.pushState;\r\n        const originalReplaceState = history.replaceState;\r\n        \r\n        history.pushState = (...args) => {\r\n            originalPushState.apply(history, args);\r\n            this.handleURLChange('pushState');\r\n        };\r\n        \r\n        history.replaceState = (...args) => {\r\n            originalReplaceState.apply(history, args);\r\n            this.handleURLChange('replaceState');\r\n        };\r\n        \r\n        this.cleanupHandlers.push(() => {\r\n            history.pushState = originalPushState;\r\n            history.replaceState = originalReplaceState;\r\n        });\r\n        \r\n        console.log('SafeSignal: History API patched for SPA detection');\r\n    }\r\n\r\n    handleURLChange(source) {\r\n        const newUrl = window.location.href;\r\n        if (newUrl !== this.currentUrl) {\r\n            console.log(`SafeSignal: URL changed (${source}):`, this.currentUrl, '→', newUrl);\r\n            this.currentUrl = newUrl;\r\n            this.currentSignature = null;\r\n            this.sessionUpdateCounts.clear();\r\n            this.debouncedPageCheck('url_change');\r\n        }\r\n    }\r\n\r\n    setupMutationObserver() {\r\n        if (!document.body) {\r\n            console.log('SafeSignal: document.body not ready, will retry after DOMContentLoaded');\r\n            const retryHandler = () => {\r\n                if (document.body) {\r\n                    this.setupMutationObserver();\r\n                }\r\n            };\r\n            document.addEventListener('DOMContentLoaded', retryHandler, { once: true });\r\n            return;\r\n        }\r\n\r\n        this.mutationObserver = new MutationObserver((mutations) => {\r\n            this.handleDOMChanges(mutations);\r\n        });\r\n\r\n        this.mutationObserver.observe(document.body, {\r\n            childList: true,\r\n            subtree: true,\r\n            attributes: false\r\n        });\r\n        \r\n        console.log('SafeSignal: MutationObserver active');\r\n    }\r\n\r\n    handleDOMChanges(mutations) {\r\n        const significantMutations = mutations.filter(mutation => {\r\n            const target = mutation.target;\r\n            \r\n            if (this.isNoisyElement(target)) {\r\n                this.trackNoisyUpdate(target);\r\n                return false;\r\n            }\r\n            \r\n            if (target.isContentEditable || \r\n                target.tagName === 'TEXTAREA' || \r\n                target.tagName === 'INPUT') {\r\n                return false;\r\n            }\r\n            \r\n            if (mutation.type === 'childList' && \r\n                mutation.addedNodes.length === 1 &&\r\n                mutation.addedNodes[0].nodeType === Node.TEXT_NODE &&\r\n                mutation.addedNodes[0].textContent.trim().length < 20) {\r\n                return false;\r\n            }\r\n            \r\n            return true;\r\n        });\r\n\r\n        if (significantMutations.length > 0) {\r\n            this.debouncedContentCheck();\r\n        }\r\n    }\r\n\r\n    isNoisyElement(element) {\r\n        if (!element || !element.closest) return false;\r\n        \r\n        const noisyTokens = new Set([\r\n            'ad', 'ads', 'advert', 'advertisement', 'sponsored', 'sponsor',\r\n            'promo', 'promotion', 'banner', 'popup', 'modal', 'overlay',\r\n            'carousel', 'slider', 'ticker', 'widget', 'sidebar',\r\n            'chat', 'live-chat', 'notification', 'toast', 'snackbar'\r\n        ]);\r\n        \r\n        if (element.classList) {\r\n            for (const className of element.classList) {\r\n                if (noisyTokens.has(className.toLowerCase())) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n        \r\n        if (element.id) {\r\n            const id = element.id.toLowerCase();\r\n            if (noisyTokens.has(id) || id.includes('google_ads') || id.includes('adsystem')) {\r\n                return true;\r\n            }\r\n        }\r\n        \r\n        try {\r\n            const noisySelectors = [\r\n                '[class*=\"google_ads\"]', '[id*=\"google_ads\"]',\r\n                '[class*=\"adsystem\"]', '[id*=\"adsystem\"]',\r\n                'iframe[src*=\"doubleclick\"]', 'iframe[src*=\"googlesyndication\"]'\r\n            ];\r\n            \r\n            return noisySelectors.some(selector => {\r\n                try {\r\n                    return element.closest(selector) !== null;\r\n                } catch (e) {\r\n                    return false;\r\n                }\r\n            });\r\n        } catch (e) {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    trackNoisyUpdate(element) {\r\n        const elementKey = this.getElementKey(element);\r\n        const count = this.sessionUpdateCounts.get(elementKey) || 0;\r\n        this.sessionUpdateCounts.set(elementKey, count + 1);\r\n        \r\n        if (count > 5) {\r\n            console.log('SafeSignal: Ignoring noisy element:', elementKey, 'updates:', count);\r\n        }\r\n    }\r\n\r\n    getElementKey(element) {\r\n        const tag = element.tagName || 'TEXT';\r\n        const id = element.id || '';\r\n        const className = element.className || '';\r\n        return `${tag}#${id}.${className}`.substring(0, 50);\r\n    }\r\n\r\n    debouncedPageCheck(reason) {\r\n        clearTimeout(this.pageDebounceTimer);\r\n        this.pageDebounceTimer = setTimeout(() => {\r\n            this.checkIfPageChanged(reason);\r\n        }, 800);\r\n    }\r\n\r\n    debouncedContentCheck() {\r\n        clearTimeout(this.contentDebounceTimer);\r\n        this.contentDebounceTimer = setTimeout(() => {\r\n            this.checkIfContentChanged('content_mutation');\r\n        }, 500);\r\n    }\r\n\r\n    async checkIfPageChanged(reason) {\r\n        console.log(`SafeSignal: Checking page change (${reason})`);\r\n        \r\n        if (reason === 'url_change' || reason === 'initial_load') {\r\n            this.updateContentSignature();\r\n            await this.performPageAnalysis(reason);\r\n            return;\r\n        }\r\n        \r\n        const now = Date.now();\r\n        const timeSinceLastCheck = now - this.lastCheck;\r\n        \r\n        if (timeSinceLastCheck < this.checkCooldown) {\r\n            console.log(`SafeSignal: Skipping check, cooldown active (${Math.round((this.checkCooldown - timeSinceLastCheck) / 1000)}s remaining)`);\r\n            return;\r\n        }\r\n        \r\n        this.updateContentSignature();\r\n        await this.performPageAnalysis(reason);\r\n    }\r\n\r\n    async checkIfContentChanged(reason) {\r\n        const newSignature = this.generateContentSignature();\r\n        \r\n        if (newSignature !== this.currentSignature) {\r\n            console.log('SafeSignal: Content signature changed:', this.currentSignature, '→', newSignature);\r\n            this.currentSignature = newSignature;\r\n            \r\n            const now = Date.now();\r\n            const timeSinceLastCheck = now - this.lastCheck;\r\n            \r\n            if (timeSinceLastCheck >= this.checkCooldown) {\r\n                await this.performPageAnalysis(reason);\r\n            } else {\r\n                console.log('SafeSignal: Content changed but cooldown active');\r\n            }\r\n        }\r\n    }\r\n\r\n    generateContentSignature() {\r\n        const mainContentEl = this.findMainContentElement();\r\n        if (!mainContentEl) {\r\n            return 'no-content';\r\n        }\r\n\r\n        const text = mainContentEl.textContent || '';\r\n        const len = text.length;\r\n        \r\n        if (len < 800) {\r\n            return 'content-too-small';\r\n        }\r\n\r\n        if (this.currentSignature) {\r\n            const prevLen = parseInt(this.currentSignature.split('|')[0], 10);\r\n            if (Math.abs(len - prevLen) < 50) {\r\n                return this.currentSignature;\r\n            }\r\n        }\r\n\r\n        const first1000 = text.substring(0, 1000);\r\n        const last1000 = text.substring(Math.max(0, len - 1000));\r\n        const linkCount = Math.min(mainContentEl.querySelectorAll('a').length, 500);\r\n        \r\n        const h1 = this.simpleHash(first1000);\r\n        const h2 = this.simpleHash(last1000);\r\n        \r\n        const signature = `${len}|${h1}|${h2}|${linkCount}`;\r\n        return signature;\r\n    }\r\n\r\n    findMainContentElement() {\r\n        const selectors = [\r\n            '[role=\"main\"]', 'main', 'article',\r\n            '.main-content', '#main-content', '.content', '#content'\r\n        ];\r\n\r\n        for (const selector of selectors) {\r\n            const el = document.querySelector(selector);\r\n            if (el && el.textContent.length >= 800) {\r\n                return el;\r\n            }\r\n        }\r\n\r\n        const candidates = Array.from(document.querySelectorAll('div')).filter(div => {\r\n            const textLen = div.textContent.length;\r\n            return textLen >= 800 && !this.isNoisyElement(div);\r\n        });\r\n\r\n        if (candidates.length === 0) return document.body;\r\n\r\n        return candidates.reduce((largest, current) => {\r\n            return current.textContent.length > largest.textContent.length ? current : largest;\r\n        });\r\n    }\r\n\r\n    simpleHash(str) {\r\n        let hash = 0;\r\n        for (let i = 0; i < str.length; i++) {\r\n            const char = str.charCodeAt(i);\r\n            hash = ((hash << 5) - hash) + char;\r\n            hash = hash & hash;\r\n        }\r\n        return Math.abs(hash);\r\n    }\r\n\r\n    updateContentSignature() {\r\n        this.currentSignature = this.generateContentSignature();\r\n        console.log('SafeSignal: Content signature updated:', this.currentSignature);\r\n    }\r\n\r\n    async performPageAnalysis(reason) {\r\n        this.lastCheck = Date.now();\r\n        console.log(`SafeSignal: Performing page analysis (${reason})`);\r\n        \r\n        this.setState('checking');\r\n        await this.simulateAnalysis();\r\n        this.determinePageState();\r\n    }\r\n\r\n    async simulateAnalysis() {\r\n        const delay = Math.random() * 1000 + 500;\r\n        await new Promise(resolve => setTimeout(resolve, delay));\r\n    }\r\n\r\n    determinePageState() {\r\n        const url = window.location.href.toLowerCase();\r\n        const hostname = window.location.hostname.toLowerCase();\r\n        const path = window.location.pathname.toLowerCase();\r\n        \r\n        if (hostname.includes('google') || hostname.includes('wikipedia') || hostname.includes('github')) {\r\n            this.setState('ok');\r\n        } else if (path.includes('/login') || path.includes('/signin') || path.includes('/payment')) {\r\n            this.setState('warning');\r\n        } else if (url.includes('?utm_') || path.includes('/ad/') || hostname.includes('doubleclick')) {\r\n            this.setState('warning');\r\n        } else if (hostname.includes('malware') || hostname.includes('phishing') || path.includes('/scam')) {\r\n            this.setState('danger');\r\n        } else {\r\n            const states = ['ok', 'warning', 'danger'];\r\n            const weights = [0.7, 0.25, 0.05];\r\n            const randomState = this.weightedRandomChoice(states, weights);\r\n            this.setState(randomState);\r\n        }\r\n    }\r\n\r\n    weightedRandomChoice(choices, weights) {\r\n        const random = Math.random();\r\n        let weightSum = 0;\r\n        \r\n        for (let i = 0; i < choices.length; i++) {\r\n            weightSum += weights[i];\r\n            if (random <= weightSum) {\r\n                return choices[i];\r\n            }\r\n        }\r\n        \r\n        return choices[choices.length - 1];\r\n    }\r\n\r\n    destroy() {\r\n        if (this.mutationObserver) {\r\n            this.mutationObserver.disconnect();\r\n            this.mutationObserver = null;\r\n        }\r\n        \r\n        [this.pageDebounceTimer, this.contentDebounceTimer, this.scrollTimer, this.longPressTimer].forEach(timer => {\r\n            if (timer) clearTimeout(timer);\r\n        });\r\n        \r\n        this.cleanupHandlers.forEach(cleanup => {\r\n            try {\r\n                cleanup();\r\n            } catch (e) {\r\n                console.warn('SafeSignal: Cleanup error:', e);\r\n            }\r\n        });\r\n        this.cleanupHandlers = [];\r\n        \r\n        if (this.badgeContainer && this.badgeContainer.parentNode) {\r\n            this.badgeContainer.parentNode.removeChild(this.badgeContainer);\r\n        }\r\n        \r\n        console.log('SafeSignal: Badge destroyed and cleaned up');\r\n    }\r\n}\r\n\r\n// Initialize badge when DOM is ready\r\nlet safesignalBadge = null;\r\n\r\nasync function initializeBadge() {\r\n    if (safesignalBadge) {\r\n        safesignalBadge.destroy();\r\n    }\r\n    \r\n    safesignalBadge = new SafeSignalBadge();\r\n}\r\n\r\nif (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', initializeBadge);\r\n} else {\r\n    initializeBadge();\r\n}\r\n\r\nwindow.addEventListener('beforeunload', () => {\r\n    if (safesignalBadge) {\r\n        safesignalBadge.destroy();\r\n    }\r\n});\r\n\r\nif (typeof window !== 'undefined') {\r\n    window.SafeSignalBadge = SafeSignalBadge;\r\n}"],"names":[],"sourceRoot":""}